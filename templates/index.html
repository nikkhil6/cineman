<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ðŸŽ¬ CineMan: Your next watch is waiting</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        rel="stylesheet"
        crossorigin="anonymous">

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- movie-integration provides poster card building and manifest handling -->
  <script src="{{ url_for('static', filename='js/movie-integration.js') }}"></script>

  <style>
    :root{
      --card-width-desktop: 200px;
      --card-width-mobile: 140px;
      --card-radius: 8px;
      --card-shadow: 0 8px 24px rgba(8,20,40,0.06);
      --card-hover-shadow: 0 14px 36px rgba(8,20,40,0.12);
      --poster-gap: 12px;
    }

    html, body { height: 100%; margin: 0; }

    body {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-image: url('/static/background.jpg');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }

    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background: rgba(255,255,255,0.06);
      pointer-events: none;
    }

    .chat-container {
      width: min(920px, 96vw);
      max-width: 920px;
      margin: 0;
      border-radius: 14px;
      background: rgba(255,255,255,0.92);
      box-shadow: 0 8px 32px rgba(2,16,34,0.08);
      overflow: hidden;
      max-height: 92vh;
      display:flex;
      flex-direction:column;
      border: 1px solid rgba(0,0,0,0.04);
    }

    .chat-header {
      padding: 12px 18px;
      display:flex;
      gap:12px;
      align-items:center;
      font-weight:700;
      background: rgba(247,247,247,0.9);
      border-bottom: 1px solid rgba(0,0,0,0.04);
    }

    .header-logo{ width:44px; height:44px; border-radius:8px; object-fit:cover; }

    #chatbox {
      padding: 20px;
      overflow-y: auto;
      scroll-behavior: smooth;
      flex: 1 1 auto;
    }

    .message-container { margin-bottom: 15px; display:flex; gap:10px; align-items:flex-start; }
    .message-container.user-container { flex-direction: row-reverse; }
    .agent-avatar{ width:36px; height:36px; border-radius:50%; object-fit:cover; flex-shrink:0; }
    .agent-message{ background: rgba(240,240,240,0.95); padding:12px 18px; border-radius:18px; max-width:85%; line-height:1.6; }
    .user-message{ background:#0070c9; color:#fff; padding:12px 18px; border-radius:18px; max-width:85%; }
    .loading-message{ background:#fff7d6; padding:10px 15px; border-radius:18px; max-width:45%; font-style:italic; color:#666; animation:pulse 1.2s infinite; }
    @keyframes pulse{ 0%{opacity:1} 50%{opacity:.6} 100%{opacity:1} }

    .suggestions { display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .chip{ background: rgba(0,112,201,0.08); color:#0070c9; padding:8px 12px; border-radius:999px; border:1px solid rgba(0,112,201,0.12); cursor:pointer; font-weight:600; }

    /* Poster area (cards are the main highlight) */
    #poster-area {
      display:flex;
      gap:var(--poster-gap);
      flex-wrap:wrap;
      justify-content:center;
      align-items:flex-start;
      margin-top: 10px;
    }

    /* poster card styling (used by movie-integration.js) */
    .poster-card { width: var(--card-width-desktop); max-width:36vw; border-radius: var(--card-radius); overflow:hidden; background:#fff; padding:10px; box-shadow: var(--card-shadow); display:flex; flex-direction:column; align-items:center; transition: transform 180ms ease, box-shadow 180ms ease; }
    .poster-card:hover{ transform: translateY(-6px); box-shadow: var(--card-hover-shadow); }
    .poster-image{ width:100%; border-radius:6px; object-fit:cover; display:block; }
    .poster-meta{ margin-top:8px; text-align:center; font-size:0.94rem; color:#111; }
    .poster-meta .title{ font-weight:700; }
    .poster-meta .year{ color:#6b7280; font-size:0.86rem; margin-top:4px; }
    .poster-meta .dir{ color:#555; font-size:0.86rem; margin-top:6px; }
    .rating-badge{ display:inline-block; margin-top:6px; padding:6px 10px; border-radius:999px; background:#f1f5f9; font-weight:600; font-size:0.86rem; color:#0f172a; margin-right:6px; }

    .poster-collapsed-tray { margin-top:10px; display:flex; flex-direction:column; gap:6px; }
    .poster-tray-btn { display:inline-flex; align-items:center; gap:8px; border-radius:999px; padding:6px 10px; border:1px solid rgba(2,6,23,0.06); background:#fff; cursor:pointer; font-weight:600; }

    .input-group-container {
      padding: 12px 16px;
      border-top: 1px solid rgba(0,0,0,0.04);
      background: rgba(255,255,255,0.96);
      display:flex;
      gap:10px;
      align-items:center;
      flex-shrink:0;
    }
    .input-group-container input[type="text"] {
      flex:1;
      min-height:46px;
      border-radius: 10px;
    }
    .btn-send { min-width:110px; }

    @media (max-width:720px){
      :root{ --card-width-desktop: var(--card-width-mobile); }
      #chatbox{ padding:14px; }
      .chat-container { width: 96vw; height: 96vh; max-width: 96vw; max-height: 96vh; }
    }
  </style>
</head>
<body>
  <div class="chat-container" role="main" aria-label="CineMan chat container">
    <div class="chat-header">
      <img src="{{ url_for('static', filename='cineman_hero.jpg') }}" class="header-logo" alt="CineMan" onerror="this.style.display='none'">
      <span>ðŸŽ¬ CineMan: Your next watch is waiting</span>
    </div>

    <div id="chatbox" class="clearfix" aria-live="polite" aria-atomic="false">
      <!-- initial greeting -->
      <div class="message-container">
        <img src="{{ url_for('static', filename='cineman_hero.jpg') }}" class="agent-avatar" alt="CineMan" onerror="this.style.display='none'">
        <div class="agent-message">Hi! I'm CineMan â€” tell me what kind of movie you're in the mood for. Or pick a suggestion below.</div>
      </div>

      <!-- suggestion chips -->
      <div class="message-container" id="suggestion-row">
        <div class="suggestions" id="suggestions" aria-hidden="false">
          <button class="chip" type="button">Sciâ€‘fi with twists</button>
          <button class="chip" type="button">Comedy for family</button>
          <button class="chip" type="button">Classic drama</button>
        </div>
      </div>

      <!-- Poster area - cards are created by the manifest handler -->
      <div id="poster-area" role="list" aria-label="Recommended movies"></div>
    </div>

    <div class="input-group-container d-flex">
      <input type="text" id="userInput" class="form-control me-2" placeholder="Ask for a sci-fi thriller or a nostalgic comedy..." aria-label="Ask CineMan for a movie">
      <!-- type="button" and no inline onclick attribute -->
      <button type="button" id="sendButton" class="btn btn-primary btn-send">Suggest</button>
    </div>
  </div>

  <script>
    // -- Global helpers used by page and movie-integration.js
    const chatbox = document.getElementById('chatbox');
    const userInput = document.getElementById('userInput');
    const sendButton = document.getElementById('sendButton');
    const suggestions = document.getElementById('suggestions');
    const posterArea = document.getElementById('poster-area');

    // addMessage: creates and appends chat bubbles; returns the message DIV element for insertion
    function addMessage(sender, message, isLoader = false) {
      const msgContainer = document.createElement('div');
      msgContainer.className = sender === 'User' ? 'message-container user-container' : 'message-container';
      const msgDiv = document.createElement('div');

      if (isLoader) {
        msgDiv.className = 'loading-message';
        msgDiv.textContent = message;
        const loadingAvatar = document.createElement('img');
        loadingAvatar.src = '/static/cineman_hero.jpg';
        loadingAvatar.className = 'agent-avatar';
        loadingAvatar.alt = 'CineMan';
        loadingAvatar.onerror = function() { this.style.display = 'none'; };
        msgContainer.appendChild(loadingAvatar);
      } else {
        msgDiv.className = sender === 'User' ? 'user-message' : 'agent-message';
        if (sender === 'Agent') {
          const avatar = document.createElement('img');
          avatar.src = '/static/cineman_hero.jpg';
          avatar.className = 'agent-avatar';
          avatar.alt = 'CineMan';
          avatar.onerror = function() { this.style.display = 'none'; };
          msgContainer.appendChild(avatar);
          msgDiv.innerHTML = marked.parse ? marked.parse(message || '') : (message || '');
        } else {
          msgDiv.textContent = message;
        }
      }

      msgContainer.appendChild(msgDiv);
      if (chatbox) chatbox.appendChild(msgContainer);
      if (chatbox) chatbox.scrollTop = chatbox.scrollHeight;
      return msgDiv;
    }

    // toggle input disabled state
    function toggleInput(disabled) {
      if (userInput) userInput.disabled = disabled;
      if (sendButton) sendButton.disabled = disabled;
      if (sendButton) sendButton.textContent = disabled ? 'Processing...' : 'Suggest';
      if (!disabled && userInput) userInput.focus();
    }

    // suggestions chips: fill input when clicked
    suggestions?.addEventListener('click', (e) => {
      const chip = e.target.closest('.chip');
      if (!chip) return;
      if (userInput) userInput.value = chip.textContent.trim();
      if (sendButton) sendButton.disabled = false;
      userInput.focus();
    });

    // Main sendMessage implementation â€” define as a top-level function so it's global
    async function sendMessageImpl() {
      console.log('sendMessageImpl invoked');
      const message = (userInput && userInput.value) ? userInput.value.trim() : '';
      if (!message) return;

      // Render user message and clear input
      addMessage('User', message);
      if (userInput) userInput.value = '';
      toggleInput(true);

      // Loading bubble
      const loaderEl = addMessage('Agent', 'CineMan is thinking...', true);

      try {
        const response = await fetch('/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message })
        });

        if (!response.ok) throw new Error(`Server returned ${response.status}`);

        const data = await response.json();

        // remove loader
        if (loaderEl && loaderEl.parentElement) loaderEl.parentElement.remove();

        // If movie-integration handler exists use it; it will render poster cards (preferred)
        if (window.handleAssistantReplyWithManifest && typeof window.handleAssistantReplyWithManifest === 'function') {
          await window.handleAssistantReplyWithManifest(data);
        } else {
          // fallback: render assistant reply into a chat bubble
          addMessage('Agent', data.response || 'No response from AI.');
        }
      } catch (err) {
        if (loaderEl && loaderEl.parentElement) loaderEl.parentElement.remove();
        console.error('sendMessageImpl error:', err);
        addMessage('Agent', 'Error: Could not connect to the AI service. Please restart the Flask server.');
      } finally {
        toggleInput(false);
      }
    }

    // Expose sendMessage globally (permanent fix)
    window.sendMessage = sendMessageImpl;

    // Robustly attach click handler to the Suggest button
    (function attachSendButton() {
      const btn = document.getElementById('sendButton');
      if (!btn) return setTimeout(attachSendButton, 200);
      if (!btn._sendAttached) {
        btn.addEventListener('click', (e) => { e.preventDefault(); try { window.sendMessage(); } catch (err) { console.error('sendButton handler error', err); } });
        // Ensure Enter key also triggers send
        if (userInput) {
          userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !btn.disabled) {
              e.preventDefault();
              window.sendMessage();
            }
          });
        }
        btn._sendAttached = true;
      }
    })();

    // Make addMessage available in window as well (used by other scripts)
    window.addMessage = addMessage;
    window.toggleInput = toggleInput;

    // If movie-integration.js hasn't exposed its handlers yet it's fine â€” handleAssistantReplyWithManifest is used when available
    // You may want to ensure movie-integration.js sets window.handleAssistantReplyWithManifest (it does in the provided file)

    // Initial greeting if none present
    window.addEventListener('DOMContentLoaded', () => {
      const existingAgentMsgs = chatbox.querySelectorAll('.agent-message');
      if (existingAgentMsgs.length === 0) {
        addMessage('Agent', "CineMan reporting for duty! Ask: 'Recommend a nostalgic 80s movie.'");
      }
    });
  </script>
</body>
</html>