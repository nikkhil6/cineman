<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ðŸŽ¬ CineMan: Your next watch is waiting</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          rel="stylesheet"
          crossorigin="anonymous">

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="{{ url_for('static', filename='js/movie-integration.js') }}"></script>

    <style>
        :root{
          --card-width-desktop: 200px;
          --card-width-mobile: 140px;
          --card-radius: 8px;
          --card-shadow: 0 8px 24px rgba(8,20,40,0.06);
          --card-hover-shadow: 0 14px 36px rgba(8,20,40,0.12);
          --poster-gap: 12px;
        }

        /* Center entire chat container vertically & horizontally (works on desktop & mobile) */
        html, body {
            height: 100%;
            margin: 0;
        }
        body {
            display: flex;
            align-items: center;    /* vertical centering */
            justify-content: center; /* horizontal centering */
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            background-color: #f5f5f5;
            background-image: url('/static/background.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
        }

        /* subtle overlay so chat container reads well on any background */
        body::before{
          content: '';
          position: fixed; inset: 0;
          background: rgba(255,255,255,0.06);
          pointer-events:none;
        }

        /* Chat container */
        .chat-container{
          width: min(920px, 96vw);
          max-width: 920px;
          margin: 0; /* centered by body flexbox */
          border-radius: 14px;
          background: rgba(255,255,255,0.92);
          box-shadow: 0 8px 32px rgba(2,16,34,0.08);
          overflow: hidden;
          max-height: 92vh;
          display: flex;
          flex-direction: column;
          border: 1px solid rgba(0,0,0,0.04);
        }

        .chat-header{
          padding: 12px 18px;
          display:flex;
          gap:12px;
          align-items:center;
          font-weight:700;
          background: rgba(247,247,247,0.9);
          border-bottom: 1px solid rgba(0,0,0,0.04);
        }

        .header-logo{ width:44px; height:44px; border-radius:8px; object-fit:cover; }

        /* chatbox grows and scrolls; input remains anchored at bottom of container */
        #chatbox {
          padding: 20px;
          overflow-y: auto;
          scroll-behavior: smooth;
          flex: 1 1 auto;
        }

        .message-container { margin-bottom: 15px; display:flex; gap:10px; align-items:flex-start; }
        .message-container.user-container { flex-direction: row-reverse; }
        .agent-avatar{ width:36px; height:36px; border-radius:50%; object-fit:cover; flex-shrink:0; }
        .agent-message{ background: rgba(240,240,240,0.95); padding:12px 18px; border-radius:18px; max-width:85%; line-height:1.6; }
        .user-message{ background:#0070c9; color:#fff; padding:12px 18px; border-radius:18px; max-width:85%; }
        .loading-message{ background:#fff7d6; padding:10px 15px; border-radius:18px; max-width:45%; font-style:italic; color:#666; animation:pulse 1.2s infinite; }
        @keyframes pulse{ 0%{opacity:1} 50%{opacity:.6} 100%{opacity:1} }

        .suggestions { display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
        .chip{ background: rgba(0,112,201,0.08); color:#0070c9; padding:8px 12px; border-radius:999px; border:1px solid rgba(0,112,201,0.12); cursor:pointer; font-weight:600; }

        .poster-row{
          display:flex;
          gap: var(--poster-gap);
          margin-top:10px;
          flex-wrap:wrap;
          justify-content:center; /* center posters horizontally in bubble */
          align-items:flex-start;
        }

        .poster-card{
          width: var(--card-width-desktop);
          max-width:36vw;
          border-radius: var(--card-radius);
          overflow:hidden;
          background:#fff;
          padding:10px;
          box-shadow: var(--card-shadow);
          display:flex;
          flex-direction:column;
          align-items:center;
          transition: transform 180ms ease, box-shadow 180ms ease;
        }
        .poster-card:hover{ transform: translateY(-6px); box-shadow: var(--card-hover-shadow); }
        .poster-image{ width:100%; border-radius:6px; object-fit:cover; display:block; }

        .poster-card .meta{ margin-top:8px; text-align:center; font-size:0.94rem; color:#111; }
        .poster-card .meta .title{ font-weight:700; }
        .poster-card .meta .year{ color:#6b7280; font-size:0.86rem; margin-top:4px; }
        .poster-card .meta .director{ color:#555; font-size:0.86rem; margin-top:6px; }
        .rating-badge{ display:inline-block; margin-top:6px; padding:6px 10px; border-radius:999px; background:#f1f5f9; font-weight:600; font-size:0.86rem; color:#0f172a; }

        .poster-collapsed-tray { margin-top:10px; display:flex; flex-direction:column; gap:6px; }
        .poster-tray-btn { display:inline-flex; align-items:center; gap:8px; border-radius:999px; padding:6px 10px; border:1px solid rgba(2,6,23,0.06); background:#fff; cursor:pointer; font-weight:600; }

        .input-group-container {
            padding: 12px 16px;
            border-top: 1px solid rgba(0,0,0,0.04);
            background: rgba(255,255,255,0.96);
            display:flex;
            gap:10px;
            align-items:center;
            flex-shrink:0;
        }
        .input-group-container input[type="text"] {
            flex:1;
            min-height:46px;
            border-radius: 10px;
        }
        .btn-send { min-width:110px; }

        @media (max-width:720px){
          :root{ --card-width-desktop: var(--card-width-mobile); }
          .poster-row.inline-poster-row{ flex-direction: column; gap:8px; align-items:center; }
          #chatbox{ padding:14px; }
          .chat-container { width: 96vw; height: 96vh; max-width: 96vw; max-height: 96vh; }
        }
    </style>
</head>
<body>
    <div class="chat-container" role="main" aria-label="CineMan chat container">
        <div class="chat-header">
            <img src="{{ url_for('static', filename='cineman_hero.jpg') }}" class="header-logo" alt="CineMan" onerror="this.style.display='none'">
            <span>ðŸŽ¬ CineMan: Your next watch is waiting</span>
        </div>

        <div id="chatbox" class="clearfix" aria-live="polite" aria-atomic="false">
            <!-- initial greeting -->
            <div class="message-container">
                <img src="{{ url_for('static', filename='cineman_hero.jpg') }}" class="agent-avatar" alt="CineMan" onerror="this.style.display='none'">
                <div class="agent-message">Hi! I'm CineMan â€” tell me what kind of movie you're in the mood for. Or pick a suggestion below.</div>
            </div>

            <!-- suggestion chips -->
            <div class="message-container" id="suggestion-row">
                <div class="suggestions" id="suggestions" aria-hidden="false">
                    <button class="chip" type="button">Sciâ€‘fi with twists</button>
                    <button class="chip" type="button">Comedy for family</button>
                    <button class="chip" type="button">Classic drama</button>
                </div>
            </div>
        </div>

        <div class="input-group-container d-flex">
            <input type="text" id="userInput"
                   class="form-control me-2"
                   placeholder="Ask for a sci-fi thriller or a nostalgic comedy..."
                   aria-label="Ask CineMan for a movie"
                   onkeydown="if(event.keyCode==13 && !document.getElementById('sendButton').disabled) sendMessage()">
            <button onclick="sendMessage()" class="btn btn-primary btn-send" id="sendButton">Suggest</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            crossorigin="anonymous"></script>

    <script>
        const chatbox = document.getElementById('chatbox');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const suggestions = document.getElementById('suggestions');

        function addMessage(sender, message, isLoader = false) {
            const msgContainer = document.createElement('div');
            msgContainer.className = sender === 'User' ? 'message-container user-container' : 'message-container';
            const msgDiv = document.createElement('div');

            if (isLoader) {
                msgDiv.className = 'loading-message';
                msgDiv.textContent = message;
                const loadingAvatar = document.createElement('img');
                loadingAvatar.src = '/static/cineman_hero.jpg';
                loadingAvatar.className = 'agent-avatar';
                loadingAvatar.alt = 'CineMan';
                loadingAvatar.onerror = function() { this.style.display = 'none'; };
                msgContainer.appendChild(loadingAvatar);
            } else {
                msgDiv.className = sender === 'User' ? 'user-message' : 'agent-message';
                if (sender === 'Agent') {
                    const avatar = document.createElement('img');
                    avatar.src = '/static/cineman_hero.jpg';
                    avatar.className = 'agent-avatar';
                    avatar.alt = 'CineMan';
                    avatar.onerror = function() { this.style.display = 'none'; };
                    msgContainer.appendChild(avatar);
                    // Render Markdown for the assistant message
                    msgDiv.innerHTML = marked.parse(message || '');
                } else {
                    msgDiv.textContent = message;
                }
            }

            msgContainer.appendChild(msgDiv);
            chatbox.appendChild(msgContainer);
            chatbox.scrollTop = chatbox.scrollHeight;
            return msgDiv;
        }

        function toggleInput(disabled) {
            userInput.disabled = disabled;
            sendButton.disabled = disabled;
            sendButton.textContent = disabled ? 'Processing...' : 'Suggest';
            if (!disabled) userInput.focus();
        }

        suggestions?.addEventListener('click', (e) => {
            const chip = e.target.closest('.chip');
            if (!chip) return;
            const text = chip.textContent.trim();
            userInput.value = text;
            userInput.focus();
        });

        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;

            addMessage('User', message);
            userInput.value = '';
            toggleInput(true);

            const loaderElement = addMessage('Agent', 'CineMan is thinking...', true);

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: message })
                });

                if (!response.ok) throw new Error('Non-200 response');
                const data = await response.json();

                if (loaderElement && loaderElement.parentElement) loaderElement.parentElement.remove();

                if (typeof handleAssistantReplyWithManifest === 'function') {
                    await handleAssistantReplyWithManifest(data);
                } else {
                    const assistantBubble = addMessage('Agent', data.response || 'No response from AI.');
                }

            } catch (error) {
                if (loaderElement && loaderElement.parentElement) loaderElement.parentElement.remove();
                addMessage('Agent', 'Error: Could not connect to the AI service. Please restart the Flask server.');
                console.error('API Error:', error);
            } finally {
                toggleInput(false);
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            const existingAgentMsgs = chatbox.querySelectorAll('.agent-message');
            if (existingAgentMsgs.length === 0) {
                addMessage('Agent', "CineMan reporting for duty! Ask: 'Recommend a nostalgic 80s movie.'");
            }
        });
    </script>
</body>
</html>