<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ðŸŽ¬ CineMan: Discover Movies</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        rel="stylesheet"
        crossorigin="anonymous">
  <link href="{{ url_for('static', filename='css/api-status.css') }}" rel="stylesheet">
  <link href="{{ url_for('static', filename='css/session-timer.css') }}" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="{{ url_for('static', filename='js/movie-integration.js') }}"></script>
  <script src="{{ url_for('static', filename='js/watchlist.js') }}"></script>
  <script src="{{ url_for('static', filename='js/api-status.js') }}"></script>
  <script src="{{ url_for('static', filename='js/session-timer.js') }}"></script>

  <style>
    :root{
      --card-width-desktop: 220px;
      --card-width-mobile: 150px;
      --card-radius: 10px;
      --card-shadow: 0 10px 36px rgba(8,20,40,0.08);
      --card-hover-shadow: 0 18px 46px rgba(8,20,40,0.12);
      --poster-gap: 14px;
      --modal-max-width: 880px;
      --modal-padding: 20px;
    }

    html, body { height:100%; margin:0; }

    body {
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:100vh;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-image: url('/static/background.jpg');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      padding: 0 20px;
    }

    .main-layout {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      width: 100%;
      max-width: 1400px;
    }

    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background: rgba(255,255,255,0.06);
      pointer-events: none;
    }

    .chat-container{
      width: min(960px, 96vw);
      max-width: 960px;
      margin: 0;
      border-radius: 14px;
      background: rgba(255,255,255,0.94);
      box-shadow: 0 12px 40px rgba(2,16,34,0.08);
      display:flex;
      flex-direction:column;
      max-height: 92vh;
      overflow: hidden;
      border: 1px solid rgba(0,0,0,0.04);
      /* Note: Fixed position elements escape overflow:hidden */
    }

    .chat-header{ padding:12px 18px; display:flex; gap:12px; align-items:center; font-weight:700; background: rgba(247,247,247,0.9); border-bottom:1px solid rgba(0,0,0,0.04); justify-content:space-between; }
    .header-logo{ width:44px; height:44px; border-radius:8px; object-fit:cover; }
    .header-left { display:flex; gap:12px; align-items:center; }
    .header-right { display:flex; gap:10px; align-items:center; }
    .watchlist-icon-btn { background:#2563eb; color:#fff; border:none; padding:10px 16px; border-radius:8px; cursor:pointer; font-weight:600; display:flex; align-items:center; gap:6px; transition:all 0.2s; }
    .watchlist-icon-btn:hover { background:#1d4ed8; transform:translateY(-1px); }
    .watchlist-badge { background:#dc2626; color:#fff; border-radius:999px; padding:2px 6px; font-size:0.75rem; min-width:20px; text-align:center; }

    #chatbox { padding:18px; overflow-y:auto; flex:1 1 auto; scroll-behavior: smooth; }

    /* Message layout */
    .message-container { margin-bottom: 15px; display:flex; gap:10px; align-items:flex-start; }
    .message-container.user-container { justify-content: flex-end; } /* push user's bubble to the right */
    .agent-avatar, .user-avatar { width:36px; height:36px; border-radius:50%; object-fit:cover; flex-shrink:0; }
    .agent-message{ background: rgba(240,240,240,0.95); padding:12px 18px; border-radius:18px; max-width:85%; line-height:1.6; margin-right:auto; }
    .user-message{ background:#0070c9; color:#fff; padding:12px 18px; border-radius:18px; max-width:85%; margin-left:auto; }

    .loading-message{ background:#fff7d6; padding:10px 15px; border-radius:18px; max-width:45%; font-style:italic; color:#666; animation:pulse 1.2s infinite; }
    @keyframes pulse{ 0%{opacity:1} 50%{opacity:.6} 100%{opacity:1} }

    .suggestions { display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .chip { background: rgba(0,112,201,0.08); color:#0070c9; padding:8px 12px; border-radius:999px; border:1px solid rgba(0,112,201,0.12); cursor:pointer; font-weight:600; }

    /* poster row used inside an agent bubble (inserted into chat) */
    .poster-row { display:flex; gap:var(--poster-gap); flex-wrap:wrap; justify-content:center; align-items:flex-start; margin-top:10px; scroll-behavior: smooth; }
    
    /* Mobile: horizontal scrolling for poster cards */
    @media (max-width: 768px) {
      .poster-row { 
        flex-wrap: nowrap; 
        overflow-x: auto; 
        overflow-y: hidden;
        justify-content: flex-start;
        scroll-snap-type: x mandatory;
        -webkit-overflow-scrolling: touch;
        padding: 10px 0;
      }
      .flip-card { 
        flex-shrink: 0; 
        scroll-snap-align: center;
      }
      /* Hide scrollbar but keep functionality */
      .poster-row::-webkit-scrollbar { display: none; }
      .poster-row { -ms-overflow-style: none; scrollbar-width: none; }
    }

    /* flip card */
    .flip-card { 
      width: var(--card-width-desktop); 
      perspective: 1200px; 
      -webkit-perspective:1200px; 
      display:block; 
      outline:none; 
      cursor:pointer; 
      transition: transform 0.3s ease, box-shadow 0.3s ease; 
      position: relative; 
      z-index: 1; 
    }
    .flip-card:hover:not(.is-flipped) { 
      transform: translateY(-6px) scale(1.02); 
      box-shadow: 0 12px 24px rgba(0,0,0,0.15);
    }
    .flip-card:hover:not(.is-flipped)::before {
      content: '';
      position: absolute;
      inset: 0;
      border: 2px solid rgba(37, 99, 235, 0.4);
      border-radius: var(--card-radius);
      pointer-events: none;
      z-index: 10;
      animation: pulseGlow 1.5s ease-in-out infinite;
    }
    @keyframes pulseGlow {
      0%, 100% { border-color: rgba(37, 99, 235, 0.4); }
      50% { border-color: rgba(37, 99, 235, 0.7); }
    }

    .flip-card-inner { 
      position: relative; 
      width:100%; 
      transform-style: preserve-3d; 
      transition: transform 0.6s cubic-bezier(0.4, 0.0, 0.2, 1); 
      box-sizing:border-box; 
      min-height: 480px; 
    }
    
    /* When flipped, expand to larger size and center */
    .flip-card.is-flipped { 
      position: fixed; 
      top: 50%; 
      left: 50%; 
      transform: translate(-50%, -50%); 
      width: min(800px, 90vw); 
      z-index: 3000; 
      max-height: 90vh;
      overflow: visible;
      height: auto;
    }
    .flip-card.is-flipped .flip-card-inner { 
      transform: rotateY(180deg); 
      min-height: auto;
      max-height: 90vh;
      overflow: visible;
      height: auto;
    }
    .flip-card.is-flipped .flip-card-back {
      max-height: 90vh;
      overflow-y: auto;
      overflow-x: hidden;
      display: flex;
      flex-direction: column;
    }
    
    /* Backdrop blur when card is flipped */
    .poster-row::after {
      content: '';
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 2999;
    }
    .poster-row.has-flipped-card::after {
      opacity: 1;
      pointer-events: auto;
    }
    
    .flip-card-face { 
      position:absolute; 
      width:100%; 
      height:100%; 
      top:0; 
      left:0; 
      backface-visibility:hidden; 
      -webkit-backface-visibility:hidden; 
      border-radius: var(--card-radius); 
      overflow:hidden; 
      background:#fff; 
      display:flex; 
      flex-direction:column; 
      padding:10px; 
      box-shadow: var(--card-shadow); 
    }
    .flip-card-front { z-index:2; align-items:center; }
    .flip-card-back { 
      transform: rotateY(180deg); 
      z-index:1; 
      padding:16px; 
      overflow-y: auto; 
      overflow-x: hidden;
      background: linear-gradient(180deg,#ffffff,#fbfbfb); 
      align-items:stretch;
      max-height: 100%;
    }

    .poster-image { width:100%; height:280px; object-fit:cover; border-radius:6px; display:block; }
    .poster-meta { margin-top:8px; text-align:center; font-size:0.95rem; color:#111; }
    .poster-meta .title { font-weight:700; font-size:0.92rem; }
    .poster-meta .year { color:#6b7280; font-size:0.8rem; margin-top:3px; }
    .poster-meta .dir { color:#555; font-size:0.8rem; margin-top:4px; }
    .rating-badge { 
      display:inline-flex; 
      align-items: center;
      gap: 3px;
      margin-top:6px; 
      padding:4px 10px; 
      border-radius:999px; 
      background: linear-gradient(135deg, #fff9e6 0%, #fef3c7 100%); 
      font-weight:700; 
      font-size:0.78rem; 
      color:#0f172a; 
      margin-right:4px; 
      border: 1px solid rgba(251, 191, 36, 0.3);
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .card-back-content { font-size:0.92rem; color:#111; line-height:1.6; }
    .card-back-content h4 { margin:12px 0 6px 0; font-size:1rem; }
    .card-back-content p { margin:6px 0; }

    .poster-collapsed-tray { margin-top:12px; display:flex; flex-direction:column; gap:6px; }
    .poster-tray-btn { display:inline-flex; align-items:center; gap:8px; border-radius:999px; padding:6px 10px; border:1px solid rgba(2,6,23,0.06); background:#fff; cursor:pointer; font-weight:600; }

    /* Action buttons for like/dislike/watchlist */
    .action-buttons { display:flex; gap:5px; justify-content:center; margin-top:8px; margin-bottom:4px; width:100%; padding:0 4px; }
    .action-btn { padding:6px 8px; border:none; border-radius:6px; cursor:pointer; font-size:0.82rem; font-weight:600; transition:all 0.2s; display:flex; align-items:center; gap:3px; flex:1; justify-content:center; min-height:32px; }
    .action-btn:hover { transform:translateY(-1px); box-shadow:0 4px 12px rgba(0,0,0,0.15); }
    .like-btn { background:#f0fdf4; color:#16a34a; border:1px solid #bbf7d0; }
    .like-btn.active { background:#16a34a; color:#fff; }
    .dislike-btn { background:#fef2f2; color:#dc2626; border:1px solid #fecaca; }
    .dislike-btn.active { background:#dc2626; color:#fff; }
    .watchlist-btn { background:#eff6ff; color:#2563eb; border:1px solid #bfdbfe; }
    .watchlist-btn.active { background:#2563eb; color:#fff; }
    
    /* Smaller buttons on back side for better content visibility */
    .flip-card-back .action-buttons { margin-top: 10px; position: sticky; bottom: 0; background: linear-gradient(180deg, transparent, #fbfbfb 20%); padding-top: 12px; padding-bottom: 8px; }
    .flip-card-back .action-btn { min-height: 32px; padding: 6px 8px; font-size: 0.85rem; }

    .input-group-container { padding:12px 16px; border-top:1px solid rgba(0,0,0,0.04); background: rgba(255,255,255,0.96); display:flex; gap:10px; align-items:center; }
    .input-group-container input[type="text"] { flex:1; min-height:46px; border-radius:10px; }

    /* Modal overlay (centered large view) */
    .poster-modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(3,6,18,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 16px;
    }
    .poster-modal-overlay.is-open { display: flex; }
    .poster-modal {
      width: min(100%, var(--modal-max-width));
      max-height: calc(100vh - 48px);
      background: #fff;
      border-radius: 12px;
      overflow: auto;
      padding: var(--modal-padding);
      box-shadow: 0 30px 80px rgba(3,6,18,0.45);
      display: flex;
      gap: 18px;
      align-items: flex-start;
      position: relative;
    }
    .poster-modal .modal-poster { width: 360px; max-width: 40%; border-radius: 8px; object-fit:cover; }
    .poster-modal .modal-body { flex: 1 1 auto; overflow:auto; }
    .poster-modal .modal-body h2 { margin-top:0; }
    .poster-modal .close-btn { position:absolute; right: 24px; top: 18px; border: none; background: transparent; font-size: 22px; cursor:pointer; color:#222; }

    /* Watchlist modal styles */
    .watchlist-modal-overlay { position:fixed; inset:0; background:rgba(3,6,18,0.6); display:none; align-items:center; justify-content:center; z-index:2000; padding:16px; }
    .watchlist-modal-overlay.is-open { display:flex; }
    .watchlist-modal { width:min(100%, 900px); max-height:calc(100vh - 48px); background:#fff; border-radius:12px; overflow:hidden; box-shadow:0 30px 80px rgba(3,6,18,0.45); display:flex; flex-direction:column; }
    .watchlist-modal-header { padding:20px; border-bottom:1px solid #e5e7eb; display:flex; justify-content:space-between; align-items:center; background:#f9fafb; }
    .watchlist-modal-header h2 { margin:0; font-size:1.5rem; }
    .watchlist-modal-body { padding:20px; overflow-y:auto; flex:1; }
    .watchlist-empty { text-align:center; padding:40px 20px; color:#6b7280; }
    .watchlist-item { display:flex; gap:16px; padding:16px; border-radius:8px; border:1px solid #e5e7eb; margin-bottom:12px; background:#fff; transition:all 0.2s; }
    .watchlist-item:hover { box-shadow:0 4px 12px rgba(0,0,0,0.08); transform:translateY(-1px); }
    .watchlist-item-poster { width:80px; height:120px; object-fit:cover; border-radius:6px; flex-shrink:0; }
    .watchlist-item-content { flex:1; }
    .watchlist-item-title { font-weight:700; font-size:1.1rem; margin-bottom:4px; }
    .watchlist-item-meta { color:#6b7280; font-size:0.9rem; margin-bottom:8px; }
    .watchlist-item-actions { display:flex; gap:8px; margin-top:8px; }
    .watchlist-remove-btn { background:#dc2626; color:#fff; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-weight:600; }
    .watchlist-remove-btn:hover { background:#b91c1c; }

    @media (max-width:720px) {
      :root{ --card-width-desktop: var(--card-width-mobile); }
      .poster-image { height:200px; }
      .flip-card-inner { min-height: 300px; }
      #chatbox { padding:14px; }
      .chat-container { width:96vw; height:96vh; max-width:96vw; max-height:96vh; }
      .poster-modal { flex-direction: column; align-items: center; }
      .poster-modal .modal-poster { max-width: 86%; width: auto; }
      .card-back-content { line-height:1.4; }
      .watchlist-item { flex-direction:column; }
      .watchlist-item-poster { width:100%; height:auto; max-height:300px; }
      .rating-badge { font-size:0.72rem; padding:3px 8px; }
      .action-btn { font-size:0.75rem; padding:5px 6px; min-height:28px; }
      .poster-meta .title { font-size:0.88rem; }
      .poster-meta .year, .poster-meta .dir { font-size:0.76rem; }
      
      /* Mobile-specific flipped card styling */
      .flip-card.is-flipped { 
        width: 95vw;
        max-height: 95vh;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }
      .flip-card.is-flipped .flip-card-inner {
        max-height: 95vh;
      }
      .flip-card.is-flipped .flip-card-back {
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }
      

    }

    /* Movie Links Container - Right Sidebar */
    .movie-links-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 16px;
      min-width: 150px;
    }

    .movie-link {
      color: rgba(255, 255, 255, 0.9);
      text-decoration: none;
      font-size: 0.9rem;
      font-weight: 500;
      padding: 10px 16px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.12);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.25);
      transition: all 0.3s ease;
      text-align: center;
      white-space: nowrap;
    }

    .movie-link:hover {
      background: rgba(255, 255, 255, 0.22);
      border-color: rgba(255, 255, 255, 0.45);
      transform: translateX(-3px);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.25);
    }

    @media (max-width: 1200px) {
      .main-layout {
        flex-direction: column;
      }
      
      .movie-links-container {
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: center;
        min-width: auto;
        width: 100%;
      }
      
      .movie-link:hover {
        transform: translateY(-2px);
      }
    }

    @media (max-width: 768px) {
      .movie-links-container {
        gap: 10px;
        padding: 10px;
      }
      
      .movie-link {
        font-size: 0.8rem;
        padding: 6px 12px;
      }
    }
  </style>
</head>
<body>
  <div class="main-layout">
    <div class="chat-container" role="main" aria-label="CineMan chat container">
    <div class="chat-header">
      <div class="header-left">
        <img src="{{ url_for('static', filename='cineman_hero.jpg') }}" class="header-logo" alt="CineMan" onerror="this.style.display='none'">
        <span>ðŸŽ¬ CineMan: Discover movies</span>
      </div>
      <div class="header-right">
        <button class="watchlist-icon-btn" id="new-session-btn" type="button" style="margin-right: 10px;">
          ðŸ”„ 
        </button>
        <button class="watchlist-icon-btn" id="watchlist-btn" type="button">
          ðŸ“‹ Watchlist
          <span class="watchlist-badge" id="watchlist-count" style="display:none;">0</span>
        </button>
      </div>
    </div>

    <div id="chatbox" aria-live="polite" aria-atomic="false">
      <!-- initial greeting -->
      <div class="message-container">
        <img src="{{ url_for('static', filename='cineman_hero.jpg') }}" class="agent-avatar" alt="CineMan" onerror="this.style.display='none'">
        <div class="agent-message">Hi! I'm CineMan â€” tell me what kind of movie you're in the mood for. Or pick a suggestion below.</div>
      </div>

      <!-- suggestion chips -->
      <div class="message-row" id="suggestion-row">
        <div class="suggestions" id="suggestions">
          <button class="chip" type="button">Sciâ€‘fi with twists</button>
          <button class="chip" type="button">Comedy for family</button>
          <button class="chip" type="button">Classic drama</button>
        </div>
      </div>

      <!-- Note: poster rows are inserted as part of an assistant message bubble by the JS handler.
           We intentionally removed a fixed #poster-area container to ensure posters appear in correct order
           (immediately after the user's message). -->
    </div>

    <div class="input-group-container d-flex">
      <input type="text" id="userInput" class="form-control me-2" placeholder="Ask for a sci-fi thriller or a nostalgic comedy..." aria-label="Ask CineMan for a movie" />
      <button type="button" id="sendButton" class="btn btn-primary btn-send">Suggest</button>
    </div>
    </div>

    <!-- Movie Website Links -->
    <div class="movie-links-container">
      <a href="https://letterboxd.com/" target="_blank" rel="noopener noreferrer" class="movie-link">Letterboxd</a>
      <a href="https://www.imdb.com/" target="_blank" rel="noopener noreferrer" class="movie-link">IMDb</a>
      <a href="https://www.rottentomatoes.com/" target="_blank" rel="noopener noreferrer" class="movie-link">Rotten Tomatoes</a>
      <a href="https://www.themoviedb.org/" target="_blank" rel="noopener noreferrer" class="movie-link">TMDb</a>
      <a href="https://www.metacritic.com/movie" target="_blank" rel="noopener noreferrer" class="movie-link">Metacritic</a>
    </div>
  </div>

  <!-- Poster Modal: opened when user clicks a poster -->
  <div id="poster-modal-overlay" class="poster-modal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="poster-modal" id="poster-modal" role="document">
      <button class="close-btn" id="poster-modal-close" aria-label="Close">âœ•</button>
      <img src="" alt="poster" class="modal-poster" id="modal-poster-img" />
      <div class="modal-body" id="modal-body">
        <h2 id="modal-title"></h2>
        <div id="modal-meta" style="color:#666;margin-bottom:12px"></div>
        <div id="modal-content" class="card-back-content"></div>
      </div>
    </div>
  </div>

  <!-- Watchlist Modal -->
  <div id="watchlist-modal-overlay" class="watchlist-modal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="watchlist-modal" id="watchlist-modal" role="document">
      <div class="watchlist-modal-header">
        <h2>ðŸ“‹ My Watchlist</h2>
        <button class="close-btn" id="watchlist-modal-close" aria-label="Close">âœ•</button>
      </div>
      <div class="watchlist-modal-body" id="watchlist-modal-body">
        <div class="watchlist-empty" id="watchlist-empty">
          <p>Your watchlist is empty. Start adding movies you want to watch later!</p>
        </div>
        <div id="watchlist-items"></div>
      </div>
    </div>
  </div>

  <script>
    // page-level helpers (unchanged behavior)
    const chatbox = document.getElementById('chatbox');
    const userInput = document.getElementById('userInput');
    const sendButton = document.getElementById('sendButton');
    const suggestions = document.getElementById('suggestions');

    function addMessage(sender, message, isLoader = false) {
      const msgContainer = document.createElement('div');
      msgContainer.className = sender === 'User' ? 'message-container user-container' : 'message-container';
      const msgDiv = document.createElement('div');

      if (isLoader) {
        msgDiv.className = 'loading-message';
        msgDiv.textContent = message;
        const loadingAvatar = document.createElement('img');
        loadingAvatar.src = '/static/cineman_hero.jpg';
        loadingAvatar.className = 'agent-avatar';
        loadingAvatar.alt = 'CineMan';
        loadingAvatar.onerror = function() { this.style.display = 'none'; };
        msgContainer.appendChild(loadingAvatar);
      } else {
        msgDiv.className = sender === 'User' ? 'user-message' : 'agent-message';
        const avatar = document.createElement('img');
        avatar.className = sender === 'User' ? 'user-avatar' : 'agent-avatar';
        avatar.alt = sender === 'User' ? 'You' : 'CineMan';
        avatar.src = sender === 'User' ? '/static/user_avatar.png' : '/static/cineman_hero.jpg';
        avatar.onerror = function() { this.style.display = 'none'; };

        // Append avatar first; CSS aligns message appropriately (user to right)
        msgContainer.appendChild(avatar);

        if (sender === 'Agent') {
          msgDiv.innerHTML = marked.parse ? marked.parse(message || '') : (message || '');
        } else {
          msgDiv.textContent = message;
        }
      }

      msgContainer.appendChild(msgDiv);
      if (chatbox) chatbox.appendChild(msgContainer);
      if (chatbox) chatbox.scrollTo({ top: chatbox.scrollHeight, behavior: 'smooth' });
      return msgDiv;
    }
    window.addMessage = addMessage;

    function toggleInput(disabled) {
      if (userInput) userInput.disabled = disabled;
      if (sendButton) sendButton.disabled = disabled;
      if (sendButton) sendButton.textContent = disabled ? 'Processing...' : 'Suggest';
      if (!disabled && userInput) userInput.focus();
    }
    window.toggleInput = toggleInput;

    suggestions?.addEventListener('click', (e) => {
      const chip = e.target.closest('.chip');
      if (!chip) return;
      if (userInput) userInput.value = chip.textContent.trim();
      if (sendButton) sendButton.disabled = false;
      userInput.focus();
    });

    // Poster modal helpers
    const modalOverlay = document.getElementById('poster-modal-overlay');
    const modalCloseBtn = document.getElementById('poster-modal-close');
    const modalPosterImg = document.getElementById('modal-poster-img');
    const modalTitle = document.getElementById('modal-title');
    const modalMeta = document.getElementById('modal-meta');
    const modalContent = document.getElementById('modal-content');

    function openPosterModal(movie, movieData, htmlOrMarkdown) {
      const posterUrl = movieData.poster || (movieData.omdb && (movieData.omdb.Poster || movieData.omdb.Poster_URL)) || (movieData.tmdb && movieData.tmdb.poster_url) || '';
      modalPosterImg.src = posterUrl;
      modalPosterImg.alt = movie.title + ' poster';
      modalTitle.textContent = movieData.tmdb?.title || movieData.omdb?.Title || movie.title;
      const year = movieData.tmdb?.year || movieData.omdb?.Year || movie.year || '';
      const director = movieData.director || (movieData.omdb && movieData.omdb.Director) || (movieData.tmdb && movieData.tmdb.director) || '';
      modalMeta.textContent = `${year ? year + ' â€¢ ' : ''}${director ? 'Dir: ' + director : ''}`;

      // If the handler passed HTML (contains <), set innerHTML directly, otherwise parse markdown
      if (typeof htmlOrMarkdown === 'string' && /<\/?[a-z][\s\S]*>/i.test(htmlOrMarkdown)) {
        modalContent.innerHTML = htmlOrMarkdown;
      } else if (typeof htmlOrMarkdown === 'string' && window.marked) {
        modalContent.innerHTML = marked.parse(htmlOrMarkdown);
      } else {
        modalContent.innerHTML = htmlOrMarkdown || '<div class="small">No summary available.</div>';
      }

      modalOverlay.classList.add('is-open');
      modalOverlay.setAttribute('aria-hidden','false');
      setTimeout(() => modalCloseBtn?.focus(), 80);
    }

    function closePosterModal() {
      modalOverlay.classList.remove('is-open');
      modalOverlay.setAttribute('aria-hidden','true');
      modalPosterImg.src = '';
      modalContent.innerHTML = '';
    }

    modalCloseBtn?.addEventListener('click', closePosterModal);
    modalOverlay?.addEventListener('click', (e) => { if (e.target === modalOverlay) closePosterModal(); });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && modalOverlay.classList.contains('is-open')) closePosterModal(); });

    // expose for the integration script
    window.openPosterModal = openPosterModal;
    window.closePosterModal = closePosterModal;

    // sendMessage implementation (exposed)
    async function sendMessageImpl() {
      const message = (userInput && userInput.value) ? userInput.value.trim() : '';
      if (!message) return;
      // 1) Render the user's message (right side)
      addMessage('User', message);
      if (userInput) userInput.value = '';
      toggleInput(true);
      // 2) show loader
      const loaderEl = addMessage('Agent', 'CineMan is thinking...', true);

      try {
        const response = await fetch('/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message })
        });
        if (!response.ok) throw new Error(`Server returned ${response.status}`);
        const data = await response.json();

        // remove loader
        if (loaderEl && loaderEl.parentElement) loaderEl.parentElement.remove();

        // let movie-integration handle posters + assistant text
        if (window.handleAssistantReplyWithManifest && typeof window.handleAssistantReplyWithManifest === 'function') {
          await window.handleAssistantReplyWithManifest(data);
        } else {
          addMessage('Agent', data.response || 'No response from AI.');
        }
      } catch (err) {
        if (loaderEl && loaderEl.parentElement) loaderEl.parentElement.remove();
        console.error('sendMessageImpl error:', err);
        addMessage('Agent', 'Error: Could not connect to the AI service. Please restart the Flask server.');
      } finally {
        toggleInput(false);
      }
    }
    window.sendMessage = sendMessageImpl;

    (function attachSendButton() {
      const btn = document.getElementById('sendButton');
      if (!btn) return setTimeout(attachSendButton, 200);
      if (!btn._sendAttached) {
        btn.addEventListener('click', (e) => { e.preventDefault(); try { window.sendMessage(); } catch (err) { console.error(err); } });
        if (userInput) {
          userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !btn.disabled) {
              e.preventDefault();
              window.sendMessage();
            }
          });
        }
        btn._sendAttached = true;
      }
    })();

    // New Session button handler
    (() => {
      const newSessionBtn = document.getElementById('new-session-btn');
      if (newSessionBtn) {
        newSessionBtn.addEventListener('click', async () => {
          if (!confirm('Are you sure you want to start a new session? This will clear your chat history and recommended movies.')) {
            return;
          }
          
          try {
            const response = await fetch('/session/clear', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' }
            });
            
            if (response.ok) {
              // Clear the chatbox
              const chatbox = document.getElementById('chatbox');
              chatbox.innerHTML = `
                <div class="message-container">
                  <img src="{{ url_for('static', filename='cineman_hero.jpg') }}" class="agent-avatar" alt="CineMan" onerror="this.style.display='none'">
                  <div class="agent-message">Hi! I'm CineMan â€” tell me what kind of movie you're in the mood for. Or pick a suggestion below.</div>
                </div>
                <div class="message-row" id="suggestion-row">
                  <div class="suggestions" id="suggestions">
                    <button class="chip" type="button">Sciâ€‘fi with twists</button>
                    <button class="chip" type="button">Comedy for family</button>
                    <button class="chip" type="button">Classic drama</button>
                  </div>
                </div>
              `;
              
              // Reload the page to reinitialize everything
              window.location.reload();
            } else {
              alert('Failed to clear session. Please try again.');
            }
          } catch (error) {
            console.error('Error clearing session:', error);
            alert('An error occurred while clearing the session.');
          }
        });
      }
    })();

    // initial greeting
    window.addEventListener('DOMContentLoaded', () => {
      const existingAgentMsgs = chatbox.querySelectorAll('.agent-message');
      if (existingAgentMsgs.length === 0) addMessage('Agent', "CineMan reporting for duty! Ask: 'Recommend a nostalgic 80s movie.'");
    });
  </script>
</body>
</html>